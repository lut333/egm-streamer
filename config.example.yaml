common:
  instance_id: "egm-ipc-101"
  log_level: "INFO"

# ------------------------------------------------------------------
# Streams: Push live video/audio to RTMP server
# ------------------------------------------------------------------
streams:
  game:
    enabled: true
    input_device: "/dev/video0"
    audio_device: "plughw:CARD=Video,DEV=0"
    resolution: "640x480"
    fps: 30
    bitrate: "3000k"  # Recommended: 1500k-3000k for 640x480
    rtmp_url: "rtmp://192.168.43.10/game/101?vhost=<>&token=<>"
    ffmpeg_params:
      preset: "superfast" # ultrafast, superfast, veryfast, faster, fast, medium, slow, slower, veryslow
      tune: "zerolatency"
      gop: 30
      extra_flags: [] # Additional FFmpeg flags if needed
      
  cam:
    enabled: true
    input_device: "/dev/video2"
    audio_device: null # No audio for camera
    resolution: "640x480"
    fps: 30
    bitrate: "1500k"  # Lower for camera-only stream
    rtmp_url: "rtmp://192.168.43.10/game/101_cam?vhost=<>&token=<>"
    ffmpeg_params:
      preset: "superfast" # ultrafast, superfast, veryfast, faster, fast, medium, slow, slower, veryslow
      tune: "zerolatency"
      gop: 30

# ------------------------------------------------------------------
# Snapshot Service: Background loop for generating live preview & refs
# ------------------------------------------------------------------
snapshot:
  enabled: true
  target_stream: "game"
  output_path: "/dev/shm/latest.jpg" # In-memory path for zero latency
  interval: 1 # Update frequency (seconds)
  quality: 2    # FFmpeg -q:v (1-31), 1=Best, 31=Worst. 2-5 is good balance.

# ------------------------------------------------------------------
# Detector: State recognition logic
# ------------------------------------------------------------------
detector:
  enabled: true
  target_stream: "game"
  
  # Control detection processing speed
  capture:
    capture_interval: 0.5  # [Effective] Detection loop interval in seconds. 0.5 = 2 checks/sec.

  # Parameter settings for matching algorithm
  detection:
    algo: dhash      # hash algorithm: dhash, phash, ahash
    hash_size: 8     # size of hash (8 -> 64 bits)
    
    # [Currently Unused / Reserved Params]
    # The following are for future multi-frame averaging features.
    # Current implementation relies on single-frame capture + debounce.
    samples: 3       
    sample_interval: 0.15

  # Optional: Base directory for refs. 
  # If set, state 'refs_dir' can be relative paths (e.g. "normal" instead of "/var/.../normal")
  base_refs_dir: "/var/lib/egm-streamer/refs"

  # ROI & Reference definitions
  states:
    NORMAL:
      refs_dir: "normal" # Or just "normal" if base_refs_dir is set
      min_match: 1    # Minimum non-required ROIs to match
      threshold: 12   # Hamming distance limit (lower = stricter)
      # One or more ROIs. If required=true, it MUST match.
      rois:
        - {name: "main", x: 100, y: 200, w: 50, h: 50, required: true}
        # Negative ROI example: 
        # If this ROI matches the reference from "PLAYING", add penalty (+100 dist)
        # Coordinates (x,y,w,h) are automatically inherited from PLAYING's "freegame-text" ROI
        - {name: "freegame_text", negative: true, ref_state: "PLAYING"}
        - {name: "main", x: 100, y: 200, w: 50, h: 50, negative: true}
  

    SELECT:
      refs_dir: "select"
      min_match: 1
      threshold: 10
      rois:
        - {name: "dialog", x: 150, y: 250, w: 80, h: 80, required: true}

    PLAYING:
      refs_dir: "playing"
      min_match: 1
      threshold: 12
      rois:
        - {name: "counter", x: 100, y: 150, w: 100, h: 50}

  priority: [SELECT, PLAYING, NORMAL]
  
  # State Machine / Anti-noise
  debounce:
    confirm_frames: 2  # How many consecutive matches to switch state
    drop_frames: 8     # How many frames to ignore after switch (cooldown)
    
  output:
    status_file: "/dev/shm/egm-101_detect.json"
    
  # Telegram Notification (Optional)
  telegram:
    enabled: false
    bot_token: "123456789:AAHxxxxxxxxxxxxxxxxxxxxxxxxxxxx"
    chat_id: "-1001234567890"
    client_id: null # Optional, defaults to common.instance_id

api:
  host: "0.0.0.0"
  port: 8080
